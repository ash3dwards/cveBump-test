const axios = require("axios");

const OSV_API = "https://api.osv.dev/v1";
const NVD_API = "https://services.nvd.nist.gov/rest/json/cves/2.0";

/**
 * Fetches vulnerability advisories from multiple upstream feeds
 * and normalises them into a common internal format.
 */
class VulnerabilityFeedClient {
  constructor(opts = {}) {
    this.nvdApiKey = opts.nvdApiKey || process.env.NVD_API_KEY;
    this.timeout = opts.timeout || 15_000;
    this.client = axios.create({
      timeout: this.timeout,
      headers: {
        "User-Agent": "cvebump-feed/1.0",
        Accept: "application/json",
      },
    });
  }

  /**
   * Query OSV for advisories matching a package URL.
   */
  async queryOSV(purl) {
    const response = await this.client.post(`${OSV_API}/query`, {
      package: { purl },
    });
    const vulns = response.data.vulns || [];
    return vulns.map((v) => this._normalise(v, "osv"));
  }

  /**
   * Query NVD by CVE ID with optional API-key rate boost.
   */
  async queryNVD(cveId) {
    const params = { cveId };
    const headers = {};
    if (this.nvdApiKey) {
      headers["apiKey"] = this.nvdApiKey;
    }

    const response = await this.client.get(NVD_API, { params, headers });
    const items = response.data.vulnerabilities || [];
    return items.map((item) => this._normalise(item.cve, "nvd"));
  }

  /**
   * Aggregate advisories from all configured feeds for a single package.
   */
  async aggregateAdvisories(purl, cveId) {
    const [osvResults, nvdResults] = await Promise.allSettled([
      this.queryOSV(purl),
      cveId ? this.queryNVD(cveId) : Promise.resolve([]),
    ]);

    const advisories = [];
    if (osvResults.status === "fulfilled") advisories.push(...osvResults.value);
    if (nvdResults.status === "fulfilled") advisories.push(...nvdResults.value);

    return {
      purl,
      cveId,
      advisories,
      sources: advisories.reduce((acc, a) => {
        acc[a.source] = (acc[a.source] || 0) + 1;
        return acc;
      }, {}),
      fetchedAt: new Date().toISOString(),
    };
  }

  _normalise(raw, source) {
    return {
      id: raw.id || raw.cveId || raw.ID,
      source,
      severity: raw.severity || raw.metrics?.cvssMetricV31?.[0]?.cvssData?.baseSeverity || "UNKNOWN",
      summary: raw.summary || raw.descriptions?.[0]?.value || "",
      aliases: raw.aliases || [],
      published: raw.published || raw.datePublished,
      modified: raw.modified || raw.lastModified,
    };
  }
}

module.exports = { VulnerabilityFeedClient };
